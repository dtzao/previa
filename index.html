<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<meta name="theme-color" content="#05080f" />

<!-- iOS: modo “app” quando adicionado à tela inicial -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<title>Consulta de Escala Operacional – PMESP</title>

<style>
* { box-sizing: border-box; }

:root{
  --bg1:#0b1a2d;
  --bg2:#05080f;
  --card:#0f172a;
  --stroke:#1f2937;
  --primary:#2563eb;
  --primary2:#1d4ed8;
  --text:#e5e7eb;
  --muted:#9ca3af;
}

/* ajuda a evitar zoom automático em iOS */
input, button { font-size: 16px; }

body {
  margin: 0;
  background: linear-gradient(180deg, var(--bg1), var(--bg2));
  font-family: "Inter", "Segoe UI", Arial, sans-serif;
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh; /* melhor no mobile */
}

/* “App frame”: centraliza e ocupa a tela */
.container {
  width: 100%;
  max-width: 620px;
  margin: 0 auto;
  min-height: 100vh;
  min-height: 100dvh;
  padding:
    calc(env(safe-area-inset-top) + 18px)
    calc(env(safe-area-inset-right) + 16px)
    calc(env(safe-area-inset-bottom) + 18px)
    calc(env(safe-area-inset-left) + 16px);

  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  gap: 14px;
  text-align: center;
}

header { margin-top: 6px; }

header h1 {
  font-size: 22px;
  font-weight: 650;
  color: #3b82f6;
  margin: 0 0 6px 0;
  letter-spacing: .2px;
}

header h2 {
  font-size: 14px;
  font-weight: 400;
  color: var(--muted);
  margin: 0;
}

/* bloco principal (input + botão) com “cara de app” */
.panel {
  margin-top: 8px;
  background: rgba(15, 23, 42, .55);
  border: 1px solid rgba(31, 41, 55, .75);
  border-radius: 18px;
  padding: 14px;
  backdrop-filter: blur(10px);
}

input {
  width: 100%;
  padding: 14px 14px;
  border-radius: 12px;
  border: 1px solid var(--stroke);
  background: #0f172a;
  color: #fff;
  text-align: center;
  outline: none;
}

input:focus {
  border-color: rgba(37,99,235,.9);
  box-shadow: 0 0 0 4px rgba(37,99,235,.18);
}

button {
  width: 100%;
  margin-top: 12px;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: var(--primary);
  color: #fff;
  font-weight: 700;
  cursor: pointer;
}

button:hover { background: var(--primary2); }
button:disabled { opacity: .6; cursor: not-allowed; }

.resultado {
  margin-top: 12px;
  padding: 18px;
  border-radius: 16px;
  display: none;
  text-align: left;
}

.encontrado {
  background: rgba(37,99,235,0.12);
  border: 1px solid rgba(37,99,235,.95);
}

.nao-encontrado {
  background: rgba(220,38,38,0.12);
  border: 1px solid rgba(220,38,38,.95);
}

.resultado p {
  margin: 0;
  font-size: 15px;
  line-height: 1.55;
}

.resultado p + p { margin-top: 10px; }

.badge-funcao {
  display: inline-block;
  margin-top: 6px;
  padding: 4px 10px;
  font-size: 12px;
  font-weight: 700;
  border-radius: 999px;
  background: rgba(59,130,246,0.15);
  border: 1px solid #3b82f6;
  color: #bfdbfe;
}

footer {
  margin-top: auto; /* empurra para o fim da tela (app feel) */
  padding-top: 10px;
  font-size: 11px;
  color: var(--muted);
  opacity: .95;
}

/* Ajustes mobile: tudo mais compacto e “na tela” */
@media (max-width: 480px) {
  header h1 { font-size: 20px; }
  header h2 { font-size: 13px; }
  .container { gap: 12px; }
  .panel { padding: 12px; border-radius: 16px; }
  .resultado { padding: 16px; border-radius: 14px; }
}
</style>
</head>

<body>
<div class="container">

  <header>
    <h1>Polícia Militar do Estado de São Paulo</h1>
    <h2>Diretoria de Pessoal · Consulta de Escala Operacional</h2>
  </header>

  <div class="panel">
    <input id="reInput" placeholder="Informe o Registro Funcional (RE)" inputmode="numeric" />
    <button id="btnConsultar" onclick="consultar()">Consultar Escala</button>
    <div id="resultado" class="resultado"></div>
  </div>

  <footer>
    Sistema de apoio administrativo – Uso interno<br />
    Desenvolvimento: Sd PM 154.466-7 Anderson Silva
  </footer>

</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vStjOw-tr--fHNCQjTq7Ufx9uZx2IsOk19PwP7GmAY_botbjA9scRBDgFJHdzeTkbPLxFZxC-6Ddy3m/pub?gid=1668908912&single=true&output=csv";

const input = document.getElementById("reInput");
const resultado = document.getElementById("resultado");
const btn = document.getElementById("btnConsultar");

input.addEventListener("input", () => {
  input.value = input.value.replace(/\D/g, "");
});

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") consultar();
});

function normalizarRE(v) { return (v || "").replace(/\D/g, ""); }

function parseCSV(text, delimiter) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];

    if (ch === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
      continue;
    }

    if (!inQuotes && ch === delimiter) {
      row.push(cur); cur = ""; continue;
    }

    if (!inQuotes && (ch === "\n" || ch === "\r")) {
      if (ch === "\r" && next === "\n") i++;
      row.push(cur); cur = "";
      if (row.some(c => (c || "").trim() !== "")) rows.push(row);
      row = [];
      continue;
    }

    cur += ch;
  }

  row.push(cur);
  if (row.some(c => (c || "").trim() !== "")) rows.push(row);

  return rows;
}

function detectarSeparador(csvText) {
  const firstLine = (csvText.split(/\r?\n/).find(l => l.trim().length) || "");
  const sc = (firstLine.match(/;/g) || []).length;
  const cc = (firstLine.match(/,/g) || []).length;
  return (sc > cc) ? ";" : ",";
}

function descolarPalavrasCriticas(t) {
  if (!t) return "";
  t = String(t).toUpperCase();

  const termos = [
    "FOLGA","MENSAL","REF","JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ",
    "JANEIRO","FEVEREIRO","MARCO","MARÇO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO",
    "EQ","EQUIPE","DIUR","NOT","DIA","NOITE"
  ];

  const re1 = new RegExp(`([A-ZÁÉÍÓÚÂÊÔÃÕÇ])(?=(${termos.join("|")}))`, "g");
  t = t.replace(re1, "$1 ");

  t = t.replace(/FOLGAMENSAL/g, "FOLGA MENSAL")
       .replace(/MENSALREF/g, "MENSAL REF");

  return t.replace(/\s+/g, " ").trim();
}

function pareceLinhaDePessoa(s) {
  if (!s) return false;
  const t = String(s).toUpperCase();
  const temRE = /\b\d{3}\.?\d{3}-?\d\b/.test(t);
  const temPostoPM =
    /\b(SD|CB|SUB\s*TEN|1º\s*SGT|2º\s*SGT|3º\s*SGT)\b/.test(t) && /\bPM\b/.test(t);
  return temRE || temPostoPM;
}

function pareceEscala(s) {
  if (!s) return false;
  const t = String(s).toUpperCase().replace(/\s+/g, " ").trim();
  if (pareceLinhaDePessoa(t)) return false;

  const chaves = [
    "FOLGA","MENSAL","REF","ESCALA","PLANT","TURNO",
    "EQ","EQUIPE","DIUR","NOT","12X","24X","ADMIN","EXPED"
  ];
  return chaves.some(k => t.includes(k));
}

function limparEscala(s) {
  if (!s) return "";
  let t = String(s).toUpperCase();
  t = t.replace(/\b(SD|CB|SUB\s*TEN|1º\s*SGT|2º\s*SGT|3º\s*SGT)\s*PM\s*\d{3}\.?\d{3}-?\d\b.*$/g, "").trim();
  t = t.replace(/\s+/g, " ").trim();
  return t;
}

function separarDados(texto) {
  let t = (texto || "").toUpperCase();
  t = descolarPalavrasCriticas(t);

  const siglas = [
    "SUB TEN PM","1º SGT PM","2º SGT PM","3º SGT PM","CB PM","SD PM",
    "BPM/M","CIA","CICC","CPAM","CPA","RPM",
    "ENCARREGADO","CGP","AUX","MOT","VTR"
  ];

  siglas.forEach(s => {
    const safe = s.replace(/\//g,"\\/");
    const r = new RegExp(`\\s*${safe}\\s*`, "g");
    t = t.replace(r, " " + s + " ");
  });

  t = t.replace(/\s+/g, " ").trim();

  let grad = "";
  const postos = ["SUB TEN PM","1º SGT PM","2º SGT PM","3º SGT PM","CB PM","SD PM"];
  for (let p of postos) {
    if (t.includes(p)) {
      grad = p;
      t = t.replace(p, "").trim();
      break;
    }
  }

  let funcao = "";
  const funcoes = ["ENCARREGADO","CGP","AUX","MOT","VTR","CICC"];
  for (let f of funcoes) {
    if (t.endsWith(f)) {
      funcao = f;
      t = t.slice(0, -f.length).trim();
      break;
    }
  }

  let unidade = "";
  const mBpm = t.match(/(\d+º?\s*BPM\/M|\d+º?\s*BPM)/i);
  if (mBpm) {
    unidade = mBpm[0].toUpperCase().replace(/\s+/g, " ").trim();
    t = t.replace(mBpm[0], "").trim();
  } else {
    const outras = ["CIA","CICC","CPAM","CPA","RPM"];
    for (let u of outras) {
      if (t.includes(u)) {
        unidade = u;
        t = t.replace(u, "").trim();
        break;
      }
    }
  }

  t = t.replace(/,+/g,"").replace(/\s+/g," ").trim();

  return { nome: `${grad} ${t}`.trim(), unidade, funcao };
}

let registros = [];
const reSet = new Set();
let carregado = false;

function setStatus(tipo, html) {
  resultado.style.display = "block";
  resultado.className = `resultado ${tipo}`;
  resultado.innerHTML = html;
}

async function carregarBase() {
  carregado = false;
  registros = [];
  reSet.clear();

  btn.disabled = true;
  setStatus("encontrado", "<p><strong>Carregando base…</strong></p><p>Aguarde alguns segundos.</p>");

  try {
    const r = await fetch(CSV_URL, { cache: "no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    let csv = await r.text();
    csv = csv.replace(/^\uFEFF/,"");

    const sep = detectarSeparador(csv);
    const rows = parseCSV(csv, sep);

    let escalaAtual = "";

    for (const row of rows) {
      const cols = row.map(c => (c || "").replace(/"/g,"").trim());

      if (cols[3] && pareceEscala(cols[3])) {
        escalaAtual = cols[3];
      }

      const texto = cols.join(" ").replace(/\s+/g, " ").trim();

      const m = texto.match(/\b\d{3}\.?\d{3}-?\d\b/);
      if (!m) continue;

      const re = normalizarRE(m[0]);
      if (reSet.has(re)) continue;
      reSet.add(re);

      let limpo = texto.replace(m[0], " ");

      if (escalaAtual) {
        const esc = String(escalaAtual).toUpperCase().replace(/\s+/g, " ").trim();
        const escRe = new RegExp(esc.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "i");
        limpo = limpo.replace(escRe, " ");
      }

      limpo = descolarPalavrasCriticas(limpo);
      limpo = limpo.replace(/\s+/g, " ").trim();

      const dados = separarDados(limpo);

      registros.push({
        re,
        reBase: re.slice(0,-1),
        ...dados,
        escala: limparEscala(escalaAtual)
      });
    }

    carregado = true;
    btn.disabled = false;

    // opcional: feedback de pronto
    // setStatus("encontrado", `<p><strong>Base carregada</strong></p><p>${registros.length} registros disponíveis.</p>`);
    resultado.style.display = "none";
  } catch (e) {
    btn.disabled = true;
    setStatus("nao-encontrado", `<p><strong>Falha ao carregar a base</strong></p><p>${String(e.message || e)}</p>`);
  }
}

function consultar() {
  const busca = normalizarRE(input.value);
  resultado.style.display = "none";

  if (!carregado) {
    setStatus("nao-encontrado", "<p><strong>Base ainda carregando</strong></p><p>Por favor, aguarde.</p>");
    return;
  }

  if (!busca) {
    setStatus("nao-encontrado", "<p><strong>Informe um RE</strong></p>");
    return;
  }

  const achado = registros.find(r => r.re === busca || r.reBase === busca);

  if (!achado) {
    setStatus("nao-encontrado", "<p><strong>Registro funcional não localizado</strong></p>");
  } else {
    setStatus("encontrado", `
      <p><strong>Registro localizado</strong></p>
      <p>${achado.nome || ""}</p>
      ${achado.unidade ? `<p><em>${achado.unidade}</em></p>` : ""}
      ${achado.funcao ? `<span class="badge-funcao">${achado.funcao}</span>` : ""}
      <p style="margin-top:12px;">${achado.escala || ""}</p>
    `);
  }
}

carregarBase();
</script>

</body>
</html>
