<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta de Escala Operacional â€“ PMESP</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  background: linear-gradient(180deg, #0b1a2d, #05080f);
  font-family: "Inter", "Segoe UI", Arial, sans-serif;
  color: #e5e7eb;
}

.container {
  max-width: 620px;
  margin: auto;
  padding: 40px 18px;
  text-align: center;
}

header {
  margin-bottom: 30px;
}

header h1 {
  font-size: 22px;
  font-weight: 600;
  color: #3b82f6;
  margin-bottom: 6px;
}

header h2 {
  font-size: 14px;
  font-weight: 400;
  color: #9ca3af;
}

input {
  width: 100%;
  padding: 15px;
  font-size: 17px;
  border-radius: 10px;
  border: 1px solid #1f2937;
  background: #0f172a;
  color: #fff;
  text-align: center;
}

button {
  width: 100%;
  margin-top: 16px;
  padding: 15px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  background: #2563eb;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}

button:hover {
  background: #1d4ed8;
}

.resultado {
  margin-top: 28px;
  padding: 22px;
  border-radius: 12px;
  display: none;
  text-align: left;
}

.encontrado {
  background: rgba(37,99,235,0.12);
  border: 1px solid #2563eb;
}

.nao-encontrado {
  background: rgba(220,38,38,0.12);
  border: 1px solid #dc2626;
}

.resultado p {
  margin: 0;
  font-size: 15px;
  line-height: 1.6;
}

.resultado p + p {
  margin-top: 10px;
}

.badge-funcao {
  display: inline-block;
  margin-top: 6px;
  padding: 4px 10px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 999px;
  background: rgba(59,130,246,0.15);
  border: 1px solid #3b82f6;
  color: #bfdbfe;
}

footer {
  margin-top: 45px;
  font-size: 11px;
  color: #9ca3af;
}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>PolÃ­cia Militar do Estado de SÃ£o Paulo</h1>
  <h2>Diretoria de Pessoal Â· Consulta de Escala Operacional</h2>
</header>

<input id="reInput" placeholder="Informe o Registro Funcional (RE)" inputmode="numeric">
<button onclick="consultar()">Consultar Escala</button>
<div id="resultado" class="resultado"></div>

<footer>
Sistema de apoio administrativo â€“ Uso interno<br>
Desenvolvimento: Sd PM 154.466-7 Anderson Silva
</footer>

</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vStjOw-tr--fHNCQjTq7Ufx9uZx2IsOk19PwP7GmAY_botbjA9scRBDgFJHdzeTkbPLxFZxC-6Ddy3m/pub?gid=1668908912&single=true&output=csv";

const input = document.getElementById("reInput");
const resultado = document.getElementById("resultado");

input.addEventListener("input", () => {
  input.value = input.value.replace(/\D/g, "");
});

function normalizarRE(v) {
  return (v || "").replace(/\D/g, "");
}

/* ðŸ”¹ CLASSIFICAÃ‡ÃƒO PMESP */
function separarDados(texto) {
  let t = texto.toUpperCase();

  /* ðŸ”§ 1. NORMALIZA SIGLAS COLADAS */
  const siglas = [
    "SUB TEN PM","1Âº SGT PM","2Âº SGT PM","3Âº SGT PM","CB PM","SD PM",
    "BPM/M","CIA","CICC","CPAM","CPA","RPM",
    "ENCARREGADO","CGP","AUX","MOT","VTR"
  ];

  // forÃ§a espaÃ§o antes e depois das siglas
  siglas.forEach(s => {
    const r = new RegExp(s.replace(/\//g,"\\/"), "g");
    t = t.replace(r, " " + s + " ");
  });

  // limpa excesso de espaÃ§o
  t = t.replace(/\s+/g, " ").trim();

  /* ðŸ”¹ 2. POSTO / GRADUAÃ‡ÃƒO */
  let grad = "";
  const postos = [
    "SUB TEN PM","1Âº SGT PM","2Âº SGT PM","3Âº SGT PM","CB PM","SD PM"
  ];
  for (let p of postos) {
    if (t.includes(p)) {
      grad = p;
      t = t.replace(p,"").trim();
      break;
    }
  }

  /* ðŸ”¹ 3. FUNÃ‡ÃƒO */
  let funcao = "";
  const funcoes = ["ENCARREGADO","CGP","AUX","MOT","VTR","CICC"];
  for (let f of funcoes) {
    if (t.endsWith(f)) {
      funcao = f;
      t = t.replace(f,"").trim();
      break;
    }
  }

  /* ðŸ”¹ 4. UNIDADE */
  /* ðŸ”¹ UNIDADE (sempre com nÃºmero) */
let unidade = "";

// BPM ou BPM/M com nÃºmero
const mBpm = t.match(/\d+Âº?\s*BPM\/M|\d+Âº?\s*BPM/i);
if (mBpm) {
  unidade = mBpm[0];
  t = t.replace(mBpm[0], "").trim();
} else {
  // demais unidades sem nÃºmero
  const outras = ["CIA","CICC","CPAM","CPA","RPM"];
  for (let u of outras) {
    if (t.includes(u)) {
      unidade = u;
      t = t.replace(u,"").trim();
      break;
    }
  }
}

  /* ðŸ”¹ 5. NOME (o que sobrou) */
  t = t.replace(/,+/g,"").replace(/\s+/g," ").trim();

  return {
    nome: `${grad} ${t}`.trim(),
    unidade,
    funcao
  };
}

let registros = [];
const reSet = new Set();

/* ðŸ”’ CSV BLINDADO */
fetch(CSV_URL)
.then(r => r.text())
.then(csv => {
  csv = csv.replace(/^\uFEFF/,"");
  const linhas = csv.split(/\r?\n/);
  let escalaAtual = "";

  for (let l of linhas) {
    if (!l || l.length < 5) continue;

    const cols = l.split(";").map(c => c.replace(/"/g,"").trim());
    if (cols[3]) escalaAtual = cols[3];

    const texto = cols.join(" ");
    const m = texto.match(/\d{3}\.?\d{3}-?\d/);
    if (!m) continue;

    const re = normalizarRE(m[0]);
    if (reSet.has(re)) continue;
    reSet.add(re);

    let limpo = texto.replace(m[0],"");
    if (escalaAtual) limpo = limpo.replace(escalaAtual,"");

    const dados = separarDados(limpo);

    registros.push({
      re,
      reBase: re.slice(0,-1),
      ...dados,
      escala: escalaAtual
    });
  }
});

function consultar() {
  const busca = normalizarRE(input.value);
  resultado.style.display = "none";

  const achado = registros.find(r => r.re === busca || r.reBase === busca);

  if (!achado) {
    resultado.className = "resultado nao-encontrado";
    resultado.innerHTML = "<p><strong>Registro funcional nÃ£o localizado</strong></p>";
  } else {
    resultado.className = "resultado encontrado";
    resultado.innerHTML = `
      <p><strong>Registro localizado</strong></p>
      <p>${achado.nome}</p>
      ${achado.unidade ? `<p><em>${achado.unidade}</em></p>` : ""}
      ${achado.funcao ? `<span class="badge-funcao">${achado.funcao}</span>` : ""}
      <p style="margin-top:12px;">${achado.escala}</p>
    `;
  }

  resultado.style.display = "block";
}
</script>

</body>
</html>



