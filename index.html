<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta de Escala Operacional ‚Äì PMESP</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  background: linear-gradient(180deg, #0b1a2d, #05080f);
  font-family: "Inter", "Segoe UI", Arial, sans-serif;
  color: #e5e7eb;
}

.container {
  max-width: 620px;
  margin: auto;
  padding: 40px 18px;
  text-align: center;
}

header { margin-bottom: 30px; }

header h1 {
  font-size: 22px;
  font-weight: 600;
  color: #3b82f6;
  margin-bottom: 6px;
}

header h2 {
  font-size: 14px;
  font-weight: 400;
  color: #9ca3af;
}

input {
  width: 100%;
  padding: 15px;
  font-size: 17px;
  border-radius: 10px;
  border: 1px solid #1f2937;
  background: #0f172a;
  color: #fff;
  text-align: center;
}

button {
  width: 100%;
  margin-top: 16px;
  padding: 15px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  background: #2563eb;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}

button:hover { background: #1d4ed8; }
button:disabled { opacity: .6; cursor: not-allowed; }

.resultado {
  margin-top: 28px;
  padding: 22px;
  border-radius: 12px;
  display: none;
  text-align: left;
}

.encontrado {
  background: rgba(37,99,235,0.12);
  border: 1px solid #2563eb;
}

.nao-encontrado {
  background: rgba(220,38,38,0.12);
  border: 1px solid #dc2626;
}

.resultado p {
  margin: 0;
  font-size: 15px;
  line-height: 1.6;
}

.resultado p + p { margin-top: 10px; }

.badge-funcao {
  display: inline-block;
  margin-top: 6px;
  padding: 4px 10px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 999px;
  background: rgba(59,130,246,0.15);
  border: 1px solid #3b82f6;
  color: #bfdbfe;
}

footer {
  margin-top: 45px;
  font-size: 11px;
  color: #9ca3af;
}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>Pol√≠cia Militar do Estado de S√£o Paulo</h1>
  <h2>Diretoria de Pessoal ¬∑ Consulta de Escala Operacional</h2>
</header>

<input id="reInput" placeholder="Informe o Registro Funcional (RE)" inputmode="numeric">
<button id="btnConsultar" onclick="consultar()">Consultar Escala</button>
<div id="resultado" class="resultado"></div>

<footer>
Sistema de apoio administrativo ‚Äì Uso interno<br>
Desenvolvimento: Sd PM 154.466-7 Anderson Silva
</footer>

</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vStjOw-tr--fHNCQjTq7Ufx9uZx2IsOk19PwP7GmAY_botbjA9scRBDgFJHdzeTkbPLxFZxC-6Ddy3m/pub?gid=1668908912&single=true&output=csv";

const input = document.getElementById("reInput");
const resultado = document.getElementById("resultado");
const btn = document.getElementById("btnConsultar");

input.addEventListener("input", () => {
  input.value = input.value.replace(/\D/g, "");
});

// Enter para consultar
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") consultar();
});

function normalizarRE(v) { return (v || "").replace(/\D/g, ""); }

/** CSV parser com aspas */
function parseCSV(text, delimiter) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];

    if (ch === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
      continue;
    }

    if (!inQuotes && ch === delimiter) {
      row.push(cur); cur = ""; continue;
    }

    if (!inQuotes && (ch === "\n" || ch === "\r")) {
      if (ch === "\r" && next === "\n") i++;
      row.push(cur); cur = "";
      if (row.some(c => (c || "").trim() !== "")) rows.push(row);
      row = [];
      continue;
    }

    cur += ch;
  }

  row.push(cur);
  if (row.some(c => (c || "").trim() !== "")) rows.push(row);

  return rows;
}

/** Detecta separador entre ; e , pela primeira linha n√£o-vazia */
function detectarSeparador(csvText) {
  const firstLine = (csvText.split(/\r?\n/).find(l => l.trim().length) || "");
  const sc = (firstLine.match(/;/g) || []).length;
  const cc = (firstLine.match(/,/g) || []).length;
  return (sc > cc) ? ";" : ",";
}

/** Corrige ‚Äúpalavras coladas‚Äù em pontos cr√≠ticos (ex.: TATIANEFOLGA => TATIANE FOLGA) */
function descolarPalavrasCriticas(t) {
  if (!t) return "";
  // 1) Espa√ßo antes de palavras de escala quando coladas ao final do nome
  const termos = [
    "FOLGA","MENSAL","REF","JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ",
    "JANEIRO","FEVEREIRO","MARCO","MAR√áO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"
  ];
  // Insere espa√ßo entre letra e o termo (TATIANEFOLGA -> TATIANE FOLGA)
  const re1 = new RegExp(`([A-Z√Å√â√ç√ì√ö√Ç√ä√î√É√ï√á])(?=(${termos.join("|")}))`, "g");
  t = t.replace(re1, "$1 ");

  // 2) Descola sequ√™ncias comuns coladas
  t = t.replace(/FOLGAMENSAL/g, "FOLGA MENSAL")
       .replace(/MENSALREF/g, "MENSAL REF");

  // 3) Normaliza espa√ßos
  return t.replace(/\s+/g, " ").trim();
}

/* üîπ CLASSIFICA√á√ÉO PMESP (mantendo sua l√≥gica, s√≥ mais ‚Äúblindada‚Äù) */
function separarDados(texto) {
  let t = (texto || "").toUpperCase();

  // antes de tudo, tenta descolar palavras de escala que vieram grudadas no nome
  t = descolarPalavrasCriticas(t);

  /* 1) NORMALIZA SIGLAS COLADAS */
  const siglas = [
    "SUB TEN PM","1¬∫ SGT PM","2¬∫ SGT PM","3¬∫ SGT PM","CB PM","SD PM",
    "BPM/M","CIA","CICC","CPAM","CPA","RPM",
    "ENCARREGADO","CGP","AUX","MOT","VTR"
  ];

  siglas.forEach(s => {
    const safe = s.replace(/\//g,"\\/");
    // for√ßa ‚Äúespa√ßos‚Äù ao redor sem depender de borda de palavra (para colado)
    const r = new RegExp(`\\s*${safe}\\s*`, "g");
    t = t.replace(r, " " + s + " ");
  });

  t = t.replace(/\s+/g, " ").trim();

  /* 2) POSTO / GRADUA√á√ÉO */
  let grad = "";
  const postos = ["SUB TEN PM","1¬∫ SGT PM","2¬∫ SGT PM","3¬∫ SGT PM","CB PM","SD PM"];
  for (let p of postos) {
    if (t.includes(p)) {
      grad = p;
      t = t.replace(p, "").trim();
      break;
    }
  }

  /* 3) FUN√á√ÉO */
  let funcao = "";
  const funcoes = ["ENCARREGADO","CGP","AUX","MOT","VTR","CICC"];
  for (let f of funcoes) {
    if (t.endsWith(f)) {
      funcao = f;
      t = t.slice(0, -f.length).trim();
      break;
    }
  }

  /* 4) UNIDADE (sempre com n√∫mero quando BPM) */
  let unidade = "";
  const mBpm = t.match(/(\d+¬∫?\s*BPM\/M|\d+¬∫?\s*BPM)/i);
  if (mBpm) {
    unidade = mBpm[0].toUpperCase().replace(/\s+/g, " ").trim();
    t = t.replace(mBpm[0], "").trim();
  } else {
    const outras = ["CIA","CICC","CPAM","CPA","RPM"];
    for (let u of outras) {
      if (t.includes(u)) {
        unidade = u;
        t = t.replace(u, "").trim();
        break;
      }
    }
  }

  /* 5) NOME (o que sobrou) */
  t = t.replace(/,+/g,"").replace(/\s+/g," ").trim();

  return {
    nome: `${grad} ${t}`.trim(),
    unidade,
    funcao
  };
}

let registros = [];
const reSet = new Set();
let carregado = false;

function setStatus(tipo, html) {
  resultado.style.display = "block";
  resultado.className = `resultado ${tipo}`;
  resultado.innerHTML = html;
}

async function carregarBase() {
  carregado = false;
  registros = [];
  reSet.clear();

  btn.disabled = true;
  setStatus("encontrado", "<p><strong>Carregando base‚Ä¶</strong></p><p>Aguarde alguns segundos.</p>");

  try {
    const r = await fetch(CSV_URL, { cache: "no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    let csv = await r.text();
    csv = csv.replace(/^\uFEFF/,"");

    const sep = detectarSeparador(csv);
    const rows = parseCSV(csv, sep);

    let escalaAtual = "";

    for (const row of rows) {
      // mant√©m a l√≥gica: cols[3] define escalaAtual quando existir
      const cols = row.map(c => (c || "").replace(/"/g,"").trim());
      if (cols[3]) escalaAtual = cols[3];

      // linha completa
      const texto = cols.join(" ").replace(/\s+/g, " ").trim();

      // acha RE
      const m = texto.match(/\b\d{3}\.?\d{3}-?\d\b/);
      if (!m) continue;

      const re = normalizarRE(m[0]);
      if (reSet.has(re)) continue;
      reSet.add(re);

      // remove RE
      let limpo = texto.replace(m[0], " ");

      // remove ‚ÄúescalaAtual‚Äù do corpo (pra n√£o grudar no nome)
      if (escalaAtual) {
        const esc = escalaAtual.toUpperCase().replace(/\s+/g, " ").trim();
        // remove em modo ‚Äúcase-insensitive‚Äù, respeitando espa√ßos
        const escRe = new RegExp(esc.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "i");
        limpo = limpo.replace(escRe, " ");
      }

      // adicional: se vier tipo ‚ÄúFOLGA MENSAL REF ...‚Äù no fim colado, isso √© escala, n√£o nome:
      // (mant√©m a l√≥gica, s√≥ ajuda a limpar o ‚Äúlimpo‚Äù antes de separarDados)
      limpo = limpo.toUpperCase();
      limpo = descolarPalavrasCriticas(limpo);
      limpo = limpo.replace(/\s+/g, " ").trim();

      const dados = separarDados(limpo);

      registros.push({
        re,
        reBase: re.slice(0,-1),
        ...dados,
        escala: escalaAtual
      });
    }

    carregado = true;
    btn.disabled = false;

    // opcional: feedback de pronto
    setStatus("encontrado", `<p><strong>Base carregada</strong></p><p>${registros.length} registros dispon√≠veis.</p>`);

  } catch (e) {
    btn.disabled = true;
    setStatus("nao-encontrado", `<p><strong>Falha ao carregar a base</strong></p><p>${String(e.message || e)}</p>`);
  }
}

function consultar() {
  const busca = normalizarRE(input.value);
  resultado.style.display = "none";

  if (!carregado) {
    setStatus("nao-encontrado", "<p><strong>Base ainda carregando</strong></p><p>Por favor, aguarde.</p>");
    return;
  }

  if (!busca) {
    setStatus("nao-encontrado", "<p><strong>Informe um RE</strong></p>");
    return;
  }

  const achado = registros.find(r => r.re === busca || r.reBase === busca);

  if (!achado) {
    setStatus("nao-encontrado", "<p><strong>Registro funcional n√£o localizado</strong></p>");
  } else {
    setStatus("encontrado", `
      <p><strong>Registro localizado</strong></p>
      <p>${achado.nome || ""}</p>
      ${achado.unidade ? `<p><em>${achado.unidade}</em></p>` : ""}
      ${achado.funcao ? `<span class="badge-funcao">${achado.funcao}</span>` : ""}
      <p style="margin-top:12px;">${achado.escala || ""}</p>
    `);
  }
}

// inicia carregando ao abrir
carregarBase();
</script>

</body>
</html>
